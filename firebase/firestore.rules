rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isAdmin() { return isSignedIn() && request.auth.token.admin == true; }
    function isOwner(uid) { return isSignedIn() && request.auth.uid == uid; }
    function isSiteStaff() {
      return isSignedIn() && (
        request.auth.token.admin == true ||
        request.auth.token.siteRole in ['superadmin', 'staff'] ||
        // Fallback: treat Ownly Studio and Aloft emails as site staff when custom claims aren't available
        (request.auth.token.email != null && (
          request.auth.token.email.matches('.*@ownly\\.studio$') ||
          request.auth.token.email.matches('.*aloft.*') ||
          request.auth.token.email == 'andrew@houseofkna.com'
        ))
      );
    }
    function isIn(arr, val) { return arr != null && val in arr; }

    // User profiles: users/{uid}
    match /users/{uid} {
      // Create only your own profile, with limited fields
      allow create: if isOwner(uid) &&
        request.resource.data.keys().hasOnly(['email', 'displayName', 'photoURL', 'createdAt', 'updatedAt', 'plan', 'subscriptionActive']);

      // Read your own profile, or admins can read any
      allow read: if isOwner(uid) || isAdmin();

      // Update only specific fields on your own profile; admins can update anything
      allow update: if (isOwner(uid) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['email', 'displayName', 'photoURL', 'updatedAt'])) || isAdmin();

      // Delete restricted to admins
      allow delete: if isAdmin();
    }

    // Subscriptions are written by server (Admin SDK). Allow users to read their own status.
    match /subscriptions/{docId} {
      allow read: if isAdmin() || (isSignedIn() && docId == request.auth.uid);
      // Client writes not allowed; Admin SDK bypasses these rules on the server.
      allow create, update, delete: if isAdmin();
    }

    // Organizations and RBAC - Enhanced model
    match /orgs/{orgId} {
      function isOrgMember() {
        return isSignedIn() && (
          isIn(resource.data.adminUids, request.auth.uid) ||
          isIn(resource.data.editorUids, request.auth.uid) ||
          isIn(resource.data.clientUids, request.auth.uid)
        );
      }
      
      function isOrgAdmin() {
        return isSignedIn() && isIn(resource.data.adminUids, request.auth.uid);
      }
      
      function isOrgStaff() {
        return isSignedIn() && (
          isIn(resource.data.adminUids, request.auth.uid) ||
          isIn(resource.data.editorUids, request.auth.uid)
        );
      }

      // Read: org members + site staff
      allow read: if isOrgMember() || isSiteStaff();

      // Create org: any signed-in user can create and become admin
      allow create: if isSignedIn() &&
        request.resource.data.adminUids is list &&
        request.auth.uid in request.resource.data.adminUids &&
        request.resource.data.createdBy == request.auth.uid;

      // Update/delete org: only org admins or site staff
      allow update: if isOrgAdmin() || isSiteStaff();
      allow delete: if isOrgAdmin() || isSiteStaff();

      // Projects subcollection
      match /projects/{projectId} {
        function isAssignedToProject() {
          return isSignedIn() && (
            isIn(resource.data.assignedEditorUids, request.auth.uid) ||
            isIn(resource.data.assignedClientUids, request.auth.uid)
          );
        }

        // Read: org staff + assigned team members + site staff
        allow read: if isOrgStaff() || isAssignedToProject() || isSiteStaff();
        
        // Write: org staff + site staff (clients can't directly modify projects)
        allow create, update, delete: if isOrgStaff() || isSiteStaff();
        
        // Deliverables subcollection
        match /deliverables/{deliverableId} {
          function isAssignedToDeliverable() {
            return isSignedIn() && resource.data.assignedUid == request.auth.uid;
          }
          
          function canClientSeeDeliverable() {
            return isSignedIn() && 
              resource.data.visibleToClient == true &&
              isIn(get(/databases/$(database)/documents/orgs/$(orgId)/projects/$(projectId)).data.assignedClientUids, request.auth.uid);
          }

          // Read: org staff + assigned person + clients (if visible) + site staff
          allow read: if isOrgStaff() || isAssignedToDeliverable() || canClientSeeDeliverable() || isSiteStaff();
          
          // Write: org staff + assigned person + site staff
          allow create, update, delete: if isOrgStaff() || isAssignedToDeliverable() || isSiteStaff();
        }
        
        // Milestones subcollection
        match /milestones/{milestoneId} {
          // Read: org staff + assigned project members + site staff
          allow read: if isOrgStaff() || isAssignedToProject() || isSiteStaff();
          
          // Write: org staff + site staff
          allow create, update, delete: if isOrgStaff() || isSiteStaff();
        }
      }

      // Team members subcollection (optional - for extended user info per org)
      match /members/{memberUid} {
        // Read: org members + site staff
        allow read: if isOrgMember() || isSiteStaff();
        
        // Write: org admins + site staff
        allow create, update, delete: if isOrgAdmin() || isSiteStaff();
      }

      // Invoices subcollection
      match /invoices/{invoiceId} {
        function isInvoiceRecipient() {
          return isSignedIn() && (
            resource.data.billingEmail == request.auth.token.email ||
            request.auth.uid in resource.data.sentTo
          );
        }

        // Read: org staff + invoice recipients + site staff
        allow read: if isOrgStaff() || isInvoiceRecipient() || isSiteStaff();
        
        // Write: org admins + site staff (invoicing is admin function)
        allow create, update, delete: if isOrgAdmin() || isSiteStaff();
      }

      // Activity logs subcollection
      match /activity/{activityId} {
        function canClientSeeActivity() {
          return isSignedIn() && 
            resource.data.visibleToClient == true &&
            isIn(resource.data.clientUids, request.auth.uid);
        }

        // Read: org members + site staff (filtered by visibility for clients)
        allow read: if isOrgStaff() || canClientSeeActivity() || isSiteStaff();
        
        // Create: org members + site staff (for logging actions)
        allow create: if isOrgMember() || isSiteStaff();
        
        // Update/delete: org staff + site staff
        allow update, delete: if isOrgStaff() || isSiteStaff();
      }

      // Analytics subcollection
      match /analytics/{analyticsId} {
        // Read: org admins + site staff (sensitive financial data)
        allow read: if isOrgAdmin() || isSiteStaff();
        
        // Write: site staff only (analytics are system-generated)
        allow create, update, delete: if isSiteStaff();
      }

      // Notification preferences subcollection
      match /notifications/{uid} {
        // Read/write: user's own preferences + org admins + site staff
        allow read, write: if isOwner(uid) || isOrgAdmin() || isSiteStaff();
      }
    }

    // Global activity logs (cross-org activities)
    match /globalActivity/{activityId} {
      // Read/write: site staff only
      allow read, write: if isSiteStaff();
    }

    // System settings and configurations
    match /settings/{settingId} {
      // Read: signed in users (for public settings)
      allow read: if isSignedIn();
      
      // Write: site staff only
      allow create, update, delete: if isSiteStaff();
    }

    // Deny everything else by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
